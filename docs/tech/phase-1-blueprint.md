# 第一阶段：架构设计与需求分析（Blueprint）

| **属性** | **详情** |
| --- | --- |
| **状态** | `待开发` |
| **最后更新** | 2026-01-19 |
| **关联文档** | [PRD](../prd-zh.md) · [技术评估](../tech-evaluation-zh.md) · [前端架构](../frontend-architecture-zh.md) |

---

## 目录

1. [阶段目标](#1-阶段目标)
2. [任务清单](#2-任务清单)
3. [功能清单](#3-功能清单)
4. [技术栈确认](#4-技术栈确认)
5. [页面结构规划](#5-页面结构规划)
6. [用户流程图](#6-用户流程图)
7. [验收标准](#7-验收标准)

---

## 1. 阶段目标

在编写任何业务代码之前，完成架构设计和需求分析：

- [ ] 梳理 MVP 功能清单
- [ ] 确认技术栈版本和依赖
- [ ] 定义页面路由结构
- [ ] 绘制核心用户流程图

**产出物：**
- 功能清单（按优先级划分）
- 页面路由结构图
- 技术栈确认清单
- 用户流程图

---

## 2. 任务清单

### 2.1 需求分析任务

| 序号 | 任务 | 描述 | 优先级 | 状态 |
| --- | --- | --- | --- | --- |
| 1.1 | 功能列表梳理 | 基于 PRD 整理 MVP 功能清单 | P0 | ⬜ |
| 1.2 | 页面结构规划 | 确定页面路由和层级关系 | P0 | ⬜ |
| 1.3 | 用户流程图 | 绘制核心用户操作流程 | P0 | ⬜ |
| 1.4 | 边界情况梳理 | 整理错误处理和边界场景 | P1 | ⬜ |

### 2.2 技术栈任务

| 序号 | 任务 | 描述 | 优先级 | 状态 |
| --- | --- | --- | --- | --- |
| 2.1 | 确认依赖版本 | 锁定所有技术栈版本号 | P0 | ⬜ |
| 2.2 | 依赖兼容性检查 | 确认依赖之间无冲突 | P0 | ⬜ |
| 2.3 | 文档依赖清单 | 记录所有依赖及用途 | P1 | ⬜ |

---

## 3. 功能清单

### 3.1 MVP 功能（第一阶段）

基于 PRD，以下是 MVP 阶段必须实现的功能：

#### 核心功能 - 快拍解码

| ID | 功能 | 描述 | 优先级 |
| --- | --- | --- | --- |
| FR.1.1 | 照片上传 | 支持相册选择/实时拍摄，JPG/PNG/HEIC，最大 10MB | P0 |
| FR.1.2 | AI 图像识别 | 识别宠物品种、表情、动作、环境 | P0 |
| FR.1.3 | 内心戏生成 | 生成 3 个版本内心独白供选择 | P0 |
| FR.1.4 | 结果展示 | 图片下方展示文案，支持滑动切换 | P0 |
| FR.1.5 | 重新生成 | 不满意时可"换一批" | P1 |

#### 人设系统

| ID | 功能 | 描述 | 优先级 |
| --- | --- | --- | --- |
| FR.2.1 | 预设人设 | 6 种基础人设模板 | P0 |
| FR.2.2 | 人设选择器 | 上传后可选择人设 | P0 |
| FR.2.3 | 高级人设 | 付费解锁特殊人设 | P1 |

#### 梗图生成

| ID | 功能 | 描述 | 优先级 |
| --- | --- | --- | --- |
| FR.3.1 | 梗图生成 | 文案自动排版到图片 | P0 |
| FR.3.2 | 字体选择 | 5 种网红字体 | P1 |
| FR.3.3 | 滤镜效果 | 3 种滤镜（原图/复古/黑白） | P1 |
| FR.3.4 | 水印 | 产品水印，付费可去除 | P0 |

#### 分享功能

| ID | 功能 | 描述 | 优先级 |
| --- | --- | --- | --- |
| FR.4.1 | 一键分享 | 微信/朋友圈/小红书/微博 | P0 |
| FR.4.2 | 图片保存 | 保存到本地相册 | P0 |
| FR.4.3 | 裂变二维码 | 图片带小程序码 | P1 |

### 3.2 非功能需求

| 类型 | 要求 |
| --- | --- |
| **性能** | 图片上传后 3 秒内返回结果；梗图生成 1 秒内完成 |
| **安全** | 图片 24 小时内删除；API 密钥加密 |
| **内容安全** | 敏感词过滤；图片合规审核 |
| **平台** | PWA 网页版 |
| **语言** | 简体中文 |

### 3.3 边界情况处理

| 场景 | 处理方式 |
| --- | --- |
| 图片无宠物 | 提示"未检测到宠物"，建议重新选择 |
| 图片过大/格式不支持 | 提示具体原因，引导处理 |
| API 超时/失败 | 友好提示 + 重试按钮 |
| 网络断开 | 缓存操作，恢复后继续 |
| 内容不当 | 过滤替换或重新生成 |
| 达到使用上限 | 提示开通会员或观看广告 |

---

## 4. 技术栈确认

### 4.1 核心框架

| 技术 | 版本 | 状态 | 备注 |
| --- | --- | --- | --- |
| Next.js | ^16.0.0 | ✅ 已确认 | App Router |
| React | ^19.0.0 | ✅ 已确认 | Server Components |
| TypeScript | ^5.9.0 | ✅ 已确认 | 严格模式 |
| Tailwind CSS | ^4.0.0 | ✅ 已确认 | PostCSS |

### 4.2 UI 组件

| 技术 | 版本 | 状态 | 用途 |
| --- | --- | --- | --- |
| Radix UI | ^1.1.0 | ✅ 已确认 | 无障碍基础组件 |
| Framer Motion | ^11.0.0 | ✅ 已确认 | 动画效果 |
| Swiper | ^11.0.0 | ✅ 已确认 | 滑动切换 |
| Lucide React | ^0.400.0 | ✅ 已确认 | 图标库 |

### 4.3 状态管理

| 技术 | 版本 | 状态 | 用途 |
| --- | --- | --- | --- |
| Zustand | ^5.0.0 | ✅ 已确认 | 客户端状态 |
| TanStack Query | ^5.0.0 | ✅ 已确认 | 服务端状态 |
| Zod | ^3.23.0 | ✅ 已确认 | 数据校验 |

### 4.4 图片处理

| 技术 | 版本 | 状态 | 用途 |
| --- | --- | --- | --- |
| react-dropzone | ^14.0.0 | ✅ 已确认 | 上传组件 |
| browser-image-compression | ^2.0.0 | ✅ 已确认 | 客户端压缩 |
| Konva.js | ^9.0.0 | ✅ 已确认 | 梗图编辑器 |
| react-konva | ^18.0.0 | ✅ 已确认 | React 绑定 |

### 4.5 AI 服务

| 技术 | 版本 | 状态 | 用途 |
| --- | --- | --- | --- |
| @anthropic-ai/sdk | ^0.30.0 | ✅ 已确认 | Claude API |

### 4.6 完整依赖清单

```json
{
  "dependencies": {
    "next": "^16.0.0",
    "react": "^19.0.0",
    "react-dom": "^19.0.0",

    "@radix-ui/react-dialog": "^1.1.0",
    "@radix-ui/react-dropdown-menu": "^2.1.0",
    "@radix-ui/react-select": "^2.1.0",
    "@radix-ui/react-tabs": "^1.1.0",
    "@radix-ui/react-toast": "^1.2.0",
    "@radix-ui/react-tooltip": "^1.1.0",

    "framer-motion": "^11.0.0",
    "swiper": "^11.0.0",
    "lucide-react": "^0.400.0",

    "react-dropzone": "^14.0.0",
    "browser-image-compression": "^2.0.0",
    "konva": "^9.0.0",
    "react-konva": "^18.0.0",

    "zustand": "^5.0.0",
    "@tanstack/react-query": "^5.0.0",
    "react-hook-form": "^7.50.0",
    "zod": "^3.23.0",
    "@hookform/resolvers": "^3.3.0",

    "next-pwa": "^5.6.0",

    "@anthropic-ai/sdk": "^0.30.0",

    "clsx": "^2.1.0",
    "tailwind-merge": "^2.2.0"
  },
  "devDependencies": {
    "typescript": "^5.9.0",
    "@types/react": "^19.0.0",
    "@types/node": "^22.0.0"
  }
}
```

---

## 5. 页面结构规划

### 5.1 路由结构

```
app/
├── (main)/                    # 主应用路由组
│   ├── page.tsx               # 首页（上传入口）
│   ├── generate/
│   │   └── page.tsx           # 人设选择 + 生成
│   ├── result/
│   │   └── page.tsx           # 结果展示
│   └── meme/
│       └── page.tsx           # 梗图编辑器
├── api/                       # API Routes
│   ├── generate/
│   │   └── route.ts           # AI 生成接口
│   └── upload/
│       └── route.ts           # 图片上传接口
├── layout.tsx                 # 根布局
└── globals.css                # 全局样式
```

### 5.2 页面功能映射

| 页面 | 路由 | 功能 | PRD 需求 |
| --- | --- | --- | --- |
| 首页 | `/` | 图片上传、快速开始 | FR.1.1 |
| 生成页 | `/generate` | 人设选择、开始生成 | FR.2.1, FR.2.2 |
| 结果页 | `/result` | 内心戏展示、操作 | FR.1.3, FR.1.4, FR.1.5 |
| 梗图页 | `/meme` | 梗图编辑、导出 | FR.3.x |

### 5.3 组件目录结构

```
components/
├── ui/                       # 基础 UI 组件
│   ├── button.tsx
│   ├── card.tsx
│   ├── dialog.tsx
│   ├── select.tsx
│   ├── toast.tsx
│   └── skeleton.tsx
├── upload/                   # 上传相关
│   ├── photo-uploader.tsx
│   ├── camera-capture.tsx
│   └── image-preview.tsx
├── persona/                  # 人设选择
│   ├── persona-selector.tsx
│   ├── persona-card.tsx
│   └── persona-grid.tsx
├── result/                   # 结果展示
│   ├── monologue-card.tsx
│   ├── monologue-swiper.tsx
│   └── action-bar.tsx
├── meme/                     # 梗图编辑
│   ├── meme-editor.tsx
│   ├── text-layer.tsx
│   ├── filter-selector.tsx
│   └── font-selector.tsx
├── share/                    # 分享
│   ├── share-sheet.tsx
│   └── qrcode-overlay.tsx
└── layout/                   # 布局
    ├── header.tsx
    ├── nav-bar.tsx
    └── loading-screen.tsx
```

---

## 6. 用户流程图

### 6.1 核心流程

```
┌─────────────┐
│   启动应用   │
└──────┬──────┘
       │
       ▼
┌─────────────┐     ┌─────────────┐
│   首页      │     │  检查限额   │
│  上传照片   │────▶│  是否可用?  │
└─────────────┘     └──────┬──────┘
                          │
              ┌───────────┴───────────┐
              │                       │
              ▼                       ▼
       ┌─────────────┐         ┌─────────────┐
       │   可以使用   │         │  达到上限   │
       │   继续流程   │         │  引导付费   │
       └──────┬──────┘         └─────────────┘
              │
              ▼
       ┌─────────────┐
       │   生成页    │
       │  选择人设   │
       └──────┬──────┘
              │
              ▼
       ┌─────────────┐
       │   AI 处理   │
       │  生成内心戏  │
       └──────┬──────┘
              │
              ▼
       ┌─────────────┐
       │   结果页    │
       │  展示 3 版本 │
       └──────┬──────┘
              │
    ┌─────────┼─────────┐
    │         │         │
    ▼         ▼         ▼
┌───────┐ ┌───────┐ ┌───────┐
│换一批  │ │生成梗图│ │ 分享  │
└───────┘ └───┬───┘ └───────┘
              │
              ▼
       ┌─────────────┐
       │   梗图页    │
       │  编辑导出   │
       └──────┬──────┘
              │
              ▼
       ┌─────────────┐
       │ 保存/分享   │
       └─────────────┘
```

### 6.2 错误处理流程

```
┌─────────────┐
│  任意操作   │
└──────┬──────┘
       │
       ▼
┌─────────────┐     ┌─────────────┐
│  执行操作   │────▶│  是否成功?  │
└─────────────┘     └──────┬──────┘
                          │
              ┌───────────┴───────────┐
              │                       │
              ▼                       ▼
       ┌─────────────┐         ┌─────────────┐
       │    成功     │         │    失败     │
       │   继续流程   │         │  显示错误   │
       └─────────────┘         └──────┬──────┘
                                      │
                               ┌──────┴──────┐
                               │             │
                               ▼             ▼
                        ┌─────────────┐ ┌─────────────┐
                        │  可恢复错误  │ │ 不可恢复错误 │
                        │  重试按钮   │ │  返回首页   │
                        └─────────────┘ └─────────────┘
```

---

## 7. 验收标准

### 7.1 文档完整性

- [ ] MVP 功能清单已梳理完成
- [ ] 所有功能有对应的优先级标注
- [ ] 页面路由结构已确定
- [ ] 组件目录结构已规划

### 7.2 技术栈确认

- [ ] 所有依赖版本已锁定
- [ ] 依赖之间无冲突
- [ ] 依赖用途已记录

### 7.3 流程设计

- [ ] 核心用户流程图已绘制
- [ ] 错误处理流程已设计
- [ ] 边界情况已梳理

### 7.4 检查清单

| 检查项 | 状态 |
| --- | --- |
| PRD 功能覆盖完整 | ⬜ |
| 技术栈与评估文档一致 | ⬜ |
| 页面路由结构清晰 | ⬜ |
| 组件划分合理 | ⬜ |
| 用户流程图完整 | ⬜ |
| 错误处理方案完整 | ⬜ |

---

## 下一阶段

完成第一阶段后，进入 **第二阶段：全局数据模型定义（Types）**。

详见 [phase-2-types.md](./phase-2-types.md)
